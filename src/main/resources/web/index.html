<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">NFmp3Downloader</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-red: #ea594d;
            --color-blue: #4d90b3;
            --color-cream: #f2e9e4;
            --color-dark: #3a3535;
            --color-background: #222;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        #top-controls {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;

            display: flex;
            justify-content: center;
            padding-top: 20px;

            z-index: 10;
            direction: ltr;
        }

        #top-controls>*+* {
            margin-left: 10px;
        }

        body {
            font-family: 'Varela Round', sans-serif;
            background-color: var(--color-background);
            color: var(--color-cream);

            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;

            padding-top: 60px;
            padding-bottom: 20px;
        }


        #lang-toggle {
            background: var(--color-dark);
            border: 1px solid #555;
            color: var(--color-cream);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            height: 36px;
            line-height: 24px;
            box-sizing: border-box;
        }

        #destination-section {
            display: flex;
            gap: 0;
        }

        #select-dest-btn {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            background-color: transparent;
            cursor: pointer;
            transition: border-color 0.2s;
            background-image: url('folder_ic.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: 2px solid var(--color-dark);
            border-radius: 8px;
        }

        #select-dest-btn:hover {
            border-color: var(--color-blue);
        }

        #destination-path-display {
            flex-grow: 1;
            width: 220px;
            height: 36px;
            padding: 0 10px;
            line-height: 34px;
            border-radius: 8px;
            border: 2px solid var(--color-dark);
            background-color: #3a3a3a;
            color: #ccc;
            font-size: 0.85rem;
            text-align: left;
            direction: ltr;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: default;
        }

        #netfree-control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        #netfree-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 8px;
            height: 36px;
            background-color: transparent;
            border: 2px solid var(--color-dark);
            border-radius: 8px;
            box-sizing: border-box;
        }

        #netfree-button .netfree-icon {
            height: 80%;
            width: auto;
        }

        .control-label {
            font-size: 0.65rem;
            color: #ccc;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 22px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--color-blue);
        }

        input:focus+.slider {
            box-shadow: 0 0 1px var(--color-blue);
        }

        input:checked+.slider:before {
            transform: translateX(18px);
        }

        #app-container {
            width: 100%;
            max-width: 500px;

            padding: 1.5rem 2rem 1rem 2rem;

            background-color: #2c2c2c;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--color-dark);
            text-align: center;
            margin-top: 30px;
            transition: margin-top 0.5s ease-in-out;
            position: relative;
        }

        #update-notification.visible+#app-container {
            margin-top: 0;
        }


        header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 43px;
            margin-bottom: 0;
        }

        #app-icon {
            width: 60px;
            height: 60px;
            content: url('icon.png');
        }

        h1 {
            font-size: 45px;
            color: var(--color-red);

            text-shadow:
                -1px -1px 0 #fff,
                1px -1px 0 #fff,
                -1px 1px 0 #fff,
                1px 1px 0 #fff,
                0px 4px 10px rgba(0, 0, 0, 0.5);

            margin: 0;
            font-weight: 800;
        }

        #single-link-section {
            margin-bottom: 1.5rem;
        }

        #input-section {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .input-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #youtube-url {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid var(--color-dark);
            background-color: #333;
            color: var(--color-cream);
            font-size: 1rem;
            text-align: left;
            direction: ltr;
            height: 48px;
        }

        #youtube-url:focus {
            outline: none;
            border-color: var(--color-blue);
        }

        #multi-link-toggle-btn {
            display: block;
            width: 210px;
            height: 32px;
            margin: 0 auto;
            border: none;
            background-color: transparent;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            transition: transform 0.1s, filter 0.2s;
        }

        #multi-link-toggle-btn:hover:not(:disabled) {
            filter: brightness(1.1);
        }

        #multi-link-toggle-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        html[lang="en"] #multi-link-toggle-btn {
            background-image: url('multi-link-en.png');
        }

        html[lang="he"] #multi-link-toggle-btn {
            background-image: url('multi-link-he.png');
        }

        #download-btn-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-shrink: 0;
        }

        #download-btn {
            border: none;
            background-color: transparent;
            background-image: url('download-button.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            height: 48px;
            width: 110px;
            cursor: pointer;
            transition: filter 0.3s, transform 0.1s;
        }

        #download-btn:hover:not(:disabled) {
            filter: brightness(1.15);
        }

        #download-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        #download-btn:disabled {
            cursor: not-allowed;
            filter: grayscale(1) opacity(0.5);
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .video-btn {
            height: 20px;
            width: 70px;
            padding: 0;
            font-size: 0.8rem;
            line-height: 20px;
            font-family: 'Varela Round', sans-serif;
            background-color: var(--color-dark);
            color: var(--color-cream);
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .video-btn:hover:not(:disabled) {
            background-color: #444;
            border-color: #777;
        }

        .video-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #3e3e3e;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.4);
            z-index: 1;
            border-radius: 5px;
            list-style: none;
            padding: 5px 0;
            top: 100%;
            margin-top: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .dropdown-content a {
            color: var(--color-cream);
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            text-align: center;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .dropdown-content a:hover {
            background-color: var(--color-blue);
        }

        #multi-link-section {
            margin-bottom: 1.5rem;
        }

        #multi-link-area {
            width: 100%;
            height: 150px;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--color-dark);
            background-color: #333;
            color: var(--color-cream);
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 10px;
            direction: ltr;
            text-align: left;
        }

        #multi-link-area:focus {
            outline: none;
            border-color: var(--color-blue);
        }

        .multi-link-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .multi-link-buttons button,
        .multi-link-buttons .dropdown {
            width: 80%;
        }

        #multi-download-btn {
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            background-color: var(--color-blue);
            color: white;
        }

        #multi-download-btn:hover {
            filter: brightness(1.15);
        }

        #multi-video-btn {
            height: auto;
            width: 100%;
            padding: 5px 15px;
        }

        #multi-cancel-btn {
            display: none;
        }

        .status-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            font-size: 1.1rem;
            text-align: center;
        }

        #status-error,
        #status-cancelled {
            background-color: rgba(234, 89, 77, 0.2);
            border: 1px solid var(--color-red);
        }

        #status-success {
            background-color: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
        }

        #log-link {
            color: var(--color-cream);
            text-decoration: underline;
            cursor: pointer;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--color-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .progress-bar-container {
            width: 100%;
            background-color: #333;
            border-radius: 20px;
            border: 1px solid var(--color-dark);
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: var(--color-blue);
            border-radius: 20px;
            transition: width 0.3s ease-in-out;
            text-align: center;
            line-height: 20px;
            color: white;
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            height: 30px;
        }

        .loading-dots div {
            width: 12px;
            height: 12px;
            background-color: var(--color-blue);
            border-radius: 50%;
            animation: bounce 1.2s infinite ease-in-out;
        }

        .loading-dots div:nth-child(2) {
            animation-delay: -0.2s;
        }

        .loading-dots div:nth-child(3) {
            animation-delay: -0.4s;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scale(0.8);
                opacity: 0.6;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .reset-btn {
            background-color: var(--color-blue);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 15px;
        }

        .reset-btn:hover {
            background-color: #6aabd1;
        }

        .cancel-btn-container {
            margin-top: 15px;
        }

        .cancel-btn {
            background-color: var(--color-dark);
            color: var(--color-cream);
            border: 1px solid #555;
            border-radius: 5px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .cancel-btn:hover {
            background-color: #444;
        }

        footer {
            margin-top: 10px;

            border-top: 1px solid #444;
            padding-top: 15px;

            font-size: 0.9rem;
            color: #aaa;
            text-align: center;
        }

        #bookmarklet {
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: var(--color-red);
            background-image: url('icon.png');
            background-size: 85%;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 5px;
            cursor: grab;
            user-select: none;
            font-size: 0;
            margin-top: 10px;
        }

        #bookmarklet:hover {
            background-color: #d8483b;
        }

        #update-notification {
            width: 100%;
            max-width: 500px;
            background-color: var(--color-dark);
            border: 1px solid var(--color-blue);
            border-radius: 8px;
            padding: 12px;
            color: var(--color-cream);
            overflow: hidden;

            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            border-width: 0;
            transition: all 0.5s ease-in-out;
        }

        #update-notification.visible {
            max-height: 200px;
            opacity: 1;
            padding-top: 12px;
            padding-bottom: 12px;
            border-width: 1px;
        }

        #update-text {
            font-size: 1rem;
            margin-bottom: 12px;
            font-weight: bold;
        }

        .update-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 12px;
        }

        .update-btn-main {
            padding: 6px 16px;
            font-size: 0.9rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            background-color: var(--color-blue);
            color: white;
            text-decoration: none;
            display: inline-block;
        }

        .update-btn-main:hover {
            filter: brightness(1.15);
        }

        .update-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            border-top: 1px solid #444;
            padding-top: 8px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-container label {
            font-size: 0.8rem;
            color: #ccc;
        }

        .update-btn-secondary {
            background-color: transparent;
            border: 1px solid #666;
            color: #ccc;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .update-btn-secondary:hover {
            background-color: #444;
        }

        #app-container {
            position: relative;
        }

        #top-back-btn {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            z-index: 20;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
            color: var(--color-cream);
        }

        #top-back-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        #top-back-btn svg {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: currentColor;
            stroke-width: 2.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        #settings-btn {
            position: fixed;
            top: 25px;
            left: 25px;
            height: 42px;
            width: auto;

            display: flex;
            align-items: center;
            gap: 8px;

            background: rgba(44, 44, 44, 0.9);
            border: 2px solid var(--color-dark);
            border-radius: 25px;

            cursor: pointer;
            z-index: 100;
            color: var(--color-cream);
            padding: 0 15px;

            transition: background 0.3s, border-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #settings-btn:hover {
            background: #383838;
            border-color: var(--color-blue);
            transform: scale(1.05);
        }

        #settings-btn svg {
            fill: currentColor;
            width: 20px;
            height: 20px;
            transition: transform 0.5s;
        }

        #settings-btn:hover svg {
            transform: rotate(90deg);
        }

        .settings-text {
            font-family: 'Varela Round', sans-serif;
            font-size: 0.95rem;
            font-weight: bold;
            padding-top: 2px;
        }


        #settings-sidebar {
            position: fixed;
            top: 0;
            left: -350px;
            width: 320px;
            height: 100%;
            background-color: #2c2c2c;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.7);
            z-index: 200;
            transition: left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--color-blue);
        }

        #settings-sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 25px;
            background-color: #252525;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.6rem;
            color: var(--color-cream);
        }

        #close-sidebar-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.8rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        #close-sidebar-btn:hover {
            color: var(--color-red);
        }

        .sidebar-content {
            padding: 25px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: 100%;

            gap: 20px;
        }

        .setting-row {
            background: #333;
            padding: 10px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #444;
            transition: border-color 0.2s, background 0.2s;
        }

        .setting-row.clickable:hover {
            border-color: var(--color-blue);
            background: #383838;
        }

        .setting-label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            color: #ddd;
        }

        .setting-icon-img {
            width: 24px;
            height: 24px;
        }

        #lang-select {
            background-color: #222;
            color: var(--color-cream);
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Varela Round', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            outline: none;
        }

        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #sidebar-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }

        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(3px);
            z-index: 300;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .custom-modal.visible {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: #2c2c2c;
            border: 2px solid var(--color-blue);
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-content h3 {
            color: var(--color-red);
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .modal-content p {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .modal-footer {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            border-top: 1px solid #444;
            padding-top: 15px;
        }

        #bg-color-picker {
            -webkit-appearance: none;
            border: none;
            background: none;

            width: 80px;
            height: 28px;

            cursor: pointer;
            padding: 0;
            margin: 0;
        }

        #bg-color-picker::-webkit-color-swatch {
            border: 1px solid #777;
            border-radius: 4px;
        }

        #bg-color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        html[lang="en"] header {
            flex-direction: row-reverse;
        }

        html[lang="en"] span[data-i18n="netfree_user"] {
            font-size: 0.8rem;
            line-height: 1.1;
            display: block;
            max-width: 160px;
        }
    </style>
</head>

<body>


    <button id="settings-btn" aria-label="Settings">
        <svg viewBox="0 0 24 24">
            <path
                d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.49l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
        </svg>
        <span data-i18n="settings_title" class="settings-text">×”×’×“×¨×•×ª</span>
    </button>

    <div id="settings-sidebar">
        <div class="sidebar-header">
            <h2 data-i18n="settings_title">×”×’×“×¨×•×ª</h2>
            <button id="close-sidebar-btn">âœ•</button>
        </div>

        <div class="sidebar-content">
            <div class="setting-row">
                <div class="setting-label">
                    <span class="setting-icon">ğŸŒ</span>
                    <span data-i18n="language_label">×©×¤×”</span>
                </div>
                <select id="lang-select">
                    <option value="he">×¢×‘×¨×™×ª</option>
                    <option value="en">English</option>
                </select>
            </div>

            <div class="setting-row clickable" id="dest-folder-row" style="cursor: pointer;">
                <div style="flex-grow: 1; min-width: 0; margin-inline-end: 10px;">
                    <div class="setting-label">
                        <span class="setting-icon">ğŸ“‚</span>
                        <span data-i18n="dest_folder_label">×ª×™×§×™×™×ª ×”×•×¨×“×”</span>
                    </div>
                    <div id="sidebar-dest-path"
                        style="font-size: 0.75rem; color: #888; margin-top: 4px; direction: ltr; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <span data-i18n="destination_placeholder"></span>
                    </div>
                </div>
                <span style="font-size: 1rem; color: #ffffff;">á³</span>
            </div>

            <div class="setting-row">
                <div class="setting-label">
                    <img src="netfree_ic.svg" alt="NetFree" class="setting-icon-img">
                    <span data-i18n="netfree_user">××¦×‘ ×ª××™××•×ª - × ×˜×¤×¨×™</span>
                </div>
                <label class="switch">
                    <input type="checkbox" id="netfree-toggle">
                    <span class="slider"></span>
                </label>
            </div>

            <hr style="border: 0; border-top: 1px solid #444; margin: 10px 0;">

            <div class="setting-row">
                <div class="setting-label">
                    <span class="setting-icon">ğŸ¨</span>
                    <span data-i18n="bg_color_label">×¦×‘×¢ ×¨×§×¢</span>
                </div>
                <input type="color" id="bg-color-picker" value="#222222">
            </div>

            <div class="setting-row clickable" id="bg-image-row" style="cursor: pointer;">
                <div class="setting-label">
                    <span class="setting-icon">ğŸ–¼ï¸</span>
                    <span data-i18n="bg_image_label">×ª××•× ×ª ×¨×§×¢</span>
                </div>
                <span style="font-size: 1.2rem;">á³</span>
            </div>

            <div id="reset-bg-container" style="text-align: center; display: none;">
                <button id="reset-bg-btn" class="update-btn-secondary" style="font-size: 0.9rem;"
                    data-i18n="reset_bg_label">××¤×¡ ×¨×§×¢ ×œ×‘×¨×™×¨×ª ××—×“×œ</button>
            </div>

            <div style="margin-top: auto; padding-top: 20px; text-align: center; color: #777; font-size: 0.85rem;">
                <p>
                    <span data-i18n="credits_rights">Â© All rights reserved to</span>
                    <strong>mps</strong>
                </p>
                <p style="margin-top: 5px; font-size: 0.8rem;">
                    <span data-i18n="credits_bugs">Bugs & Feedback:</span>
                    <a href="https://mail.google.com/mail/?view=cm&fs=1&to=mpsm43533@gmail.com" target="_blank"
                        style="color: #999; text-decoration: none;">mpsm43533@gmail.com </a>
                </p>
            </div>
        </div>
    </div>

    <div id="sidebar-overlay"></div>
    </div>
    </div>

    <div id="sidebar-overlay"></div>
    <div id="update-notification" class="hidden">
        <p id="update-text"></p>
        <div class="update-buttons">
            <button id="whats-new-btn" class="update-btn-main" data-i18n="whats_new">××” ×—×“×©</button>
            <a href="https://github.com/mps435/NFmp3Downloader/releases/latest" target="_blank" id="download-update-btn"
                class="update-btn-main" data-i18n="download">×”×•×¨×“</a>
        </div>
        <div class="update-footer">
            <div class="checkbox-container">
                <input type="checkbox" id="dont-show-again-checkbox">
                <label for="dont-show-again-checkbox" data-i18n="dont_show_again">××œ ×ª×¦×™×’ ×”×•×“×¢×” ×–×• ×©×•×‘</label>
            </div>
            <button id="close-update-btn" class="update-btn-secondary" data-i18n="close">×¡×’×•×¨</button>
        </div>
    </div>
    <header>
        <img id="app-icon" alt="App Icon">
        <h1 data-i18n="title">NFmp3Downloader</h1>
    </header>

    <div id="app-container">
        <button id="top-back-btn" aria-label="Back">
            <svg viewBox="0 0 24 24">
                <path d="M5 12h14M12 5l7 7-7 7" />
            </svg>
        </button>


        <main>
            <div id="main-content">
                <div id="single-link-section">
                    <div id="input-section">
                        <div class="input-wrapper">
                            <input type="url" id="youtube-url" data-i18n-placeholder="youtube_placeholder">
                            <button id="multi-link-toggle-btn"></button>
                        </div>
                        <div id="download-btn-container">
                            <button id="download-btn" data-i18n-aria-label="download_btn_aria"></button>
                            <div class="dropdown">
                                <button id="video-btn" class="video-btn"></button>
                                <div id="video-quality-dropdown" class="dropdown-content">
                                    <a href="#" data-format="bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best"
                                        data-i18n="quality_best"></a>
                                    <a href="#"
                                        data-format="bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]/best[height<=1080][ext=mp4]/best[height<=1080]"
                                        data-i18n="quality_1080p"></a>
                                    <a href="#"
                                        data-format="bestvideo[height<=720][ext=mp4]+bestaudio[ext=m4a]/best[height<=720][ext=mp4]/best[height<=720]"
                                        data-i18n="quality_720p"></a>
                                    <a href="#"
                                        data-format="bestvideo[height<=480][ext=mp4]+bestaudio[ext=m4a]/best[height<=480][ext=mp4]/best[height<=480]"
                                        data-i18n="quality_480p"></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="multi-link-section" style="display: none;">
                    <p data-i18n="multi_link_instructions"></p>
                    <textarea id="multi-link-area" data-i18n-placeholder="multi_link_placeholder"></textarea>
                    <div class="multi-link-buttons">
                        <button id="multi-download-btn"></button>
                        <div class="dropdown">
                            <button id="multi-video-btn" class="video-btn"></button>
                            <div id="multi-video-quality-dropdown" class="dropdown-content"></div>
                        </div>
                        <button id="multi-cancel-btn" data-i18n="multi_cancel_btn"></button>
                    </div>
                </div>
            </div>

            <div id="status-section">
                <div id="status-connecting" class="status-message" data-i18n="connecting"></div>
                <div id="status-launching" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="launching"></span>
                </div>
                <div id="status-requesting" class="status-message" style="display: none;">
                    <div class="loading-dots">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div><span data-i18n="requesting"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button>
                    </div>
                </div>
                <div id="status-downloading" class="status-message" style="display: none;">
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <span id="progress-text"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button>
                    </div>
                </div>
                <div id="status-playlist" class="status-message" style="display: none;">
                    <div class="loading-dots">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <span id="playlist-progress-text"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button>
                    </div>
                </div>
                <div id="status-merging" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="merging"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button>
                    </div>
                </div>
                <div id="status-processing" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="processing"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button>
                    </div>
                </div>
                <div id="status-update-check" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="update_check"></span>
                </div>
                <div id="status-updating" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="updating"></span>
                </div>
                <div id="status-success" class="status-message" style="display: none;">âœ… <span
                        id="success-text"></span><br><button class="reset-btn" data-i18n="download_another"></button>
                </div>
                <div id="status-error" class="status-message" style="display: none;">âŒ <span
                        data-i18n="error_message"></span> <span id="log-link" data-i18n="view_log"></span>.<br><button
                        class="reset-btn" data-i18n="try_again"></button>
                </div>
                <div id="status-cancelled" class="status-message" style="display: none;">ğŸš« <span
                        data-i18n="cancelled_message"></span><br><button class="reset-btn"
                        data-i18n="try_again"></button></div>
                <div id="status-queue-complete" class="status-message" style="display: none;">
                    <span id="queue-complete-icon"></span>
                    <span id="queue-complete-text"></span><br>
                    <button id="show-files-btn" class="reset-btn" data-i18n="show_files_btn"
                        style="display: none;"></button>
                    <button class="reset-btn" data-i18n="download_another"></button>
                </div>
            </div>
        </main>

        <footer>
            <p id="bookmark-info" data-i18n="bookmark_info"></p>
            <a id="bookmarklet" href="#" data-i18n="bookmark_title"></a>
        </footer>

    </div>

    <script>
        const allTranslations = {
            "en": {
                "destination_placeholder": "Save to: (Default: Downloads)",
                "success_message_custom": "The file is in: {path}",
                "multi_link_btn": "Download multiple links",
                "success_message_multi": "The files are in a new folder in your Downloads.",
                "cancel_btn": "Cancel",
                "cancelled_message": "The download was cancelled.",
                "queue_complete_perfect": "All {total} files were downloaded successfully!",
                "queue_complete_partial": "{success} of {total} files downloaded. {failed} failed.",
                "queue_complete_fail": "All {total} files failed to download.",
                "show_files_btn": "Show downloaded files",
                "downloaded_files_title": "Downloaded Files:",
                "lang_toggle": "ğŸŒ ×¢×‘×¨×™×ª", "title": "NFmp3Downloader", "connecting": "Connecting to service...", "launching": "Launching the application...",
                "requesting": "Sending request to server...", "downloading": "Downloading...", "playlist_progress": "Downloading item {current} of {total}",
                "merging": "Merging video and audio...", "processing": "Processing file... (adding thumbnail & metadata)", "update_check": "Possible error, checking for yt-dlp update...",
                "updating": "updating yt-dlp...", "success_message": "The file is in your Downloads folder.", "download_another": "Download another file",
                "error_message": "The download has failed.", "view_log": "View the log file", "try_again": "Try again", "youtube_placeholder": "https://www.youtube.com/watch?v=",
                "download_btn_aria": "Download", "quality_best": "Best Quality (MP4)", "quality_1080p": "1080p (MP4)", "quality_720p": "720p (MP4)", "quality_480p": "480p (MP4)",
                "playlist_confirm_mp3": "Playlist link detected.\n\nClick 'OK' to download the entire list.\nClick 'Cancel' to download only this single track.",
                "playlist_confirm_video": "Playlist link detected.\n\nClick 'OK' to download the entire list as video files.\nClick 'Cancel' to download only this single video.",
                "invalid_url_alert": "Please enter a valid YouTube link.", "bookmark_info": "To save as a bookmark, drag the following icon to your bookmarks bar.",
                "bookmark_title": "NFmp3Downloader", "multi_link_instructions": "Paste one YouTube link per line.", "multi_link_placeholder": "https://...\nhttps://...",
                "multi_download_btn": "Download All (MP3)", "multi_cancel_btn": "Back", "invalid_url_list_alert": "Please enter at least one valid YouTube link.",
                "netfree_user": "NetFree Compatibility Mode",
                "invalid_url_list_alert": "Please enter at least one valid YouTube link.", "update_available": "New version available!",
                "whats_new": "What's New?",
                "download": "Download",
                "dont_show_again": "Don't show this message again", "settings_title": "Settings",
                "language_label": "Language", "netfree_warning_title": "Attention: Compatibility Mode",
                "netfree_warning_text": "This mode is intended primarily for NetFree users experiencing connection issues (e.g., Bezeq providers).<br><br>If downloads work normally for you, <strong>it is recommended to keep this off</strong> for maximum speed.",
                "netfree_dont_show": "Don't show this warning again", "credits_rights": "Â© All rights reserved to",
                "credits_bugs": "Bugs & Feedback:",
                "netfree_close_btn": "I understand, close",
                "netfree_error_msg": "Error: Connection blocked by NetFree (Error 418).",
                "netfree_try_mode_btn": "Try NetFree Compatibility Mode", "bg_color_label": "Background Color", "bg_image_label": "Background Image", "reset_bg_label": "Reset Background", "dest_folder_label": "Download Folder",

                "close": "Close"

            },
            "he": {
                "destination_placeholder": "×©××•×¨ ×‘: (×‘×¨×™×¨×ª ××—×“×œ: ×”×•×¨×“×•×ª)",
                "success_message_custom": "×”×§×•×‘×¥ × ××¦× ×‘×ª×™×§×™×™×”: {path}",
                "multi_link_btn": "×”×•×¨×“ ×§×™×©×•×¨×™× ××¨×•×‘×™×",
                "success_message_multi": "×”×§×‘×¦×™× × ××¦××™× ×‘×ª×™×§×™×™×” ×—×“×©×” ×‘×ª×•×š ×ª×™×§×™×™×ª ×”×”×•×¨×“×•×ª.",
                "cancel_btn": "×‘×˜×œ",
                "cancelled_message": "×”×”×•×¨×“×” ×‘×•×˜×œ×”.",
                "queue_complete_perfect": "×›×œ {total} ×”×§×‘×¦×™× ×™×¨×“×• ×‘×”×¦×œ×—×”!",
                "queue_complete_partial": "{success} ××ª×•×š {total} ×§×‘×¦×™× ×™×¨×“×•. {failed} × ×›×©×œ×•.",
                "queue_complete_fail": "×”×”×•×¨×“×” ×©×œ ×›×œ {total} ×”×§×‘×¦×™× × ×›×©×œ×”.",
                "show_files_btn": "×”×¦×’ ×§×‘×¦×™× ×©×”×•×¨×“×•",
                "downloaded_files_title": "×§×‘×¦×™× ×©×”×•×¨×“×•:",
                "lang_toggle": "ğŸŒ English", "title": "NFmp3Downloader", "connecting": "××ª×—×‘×¨ ×œ×©×™×¨×•×ª...", "launching": "××¤×¢×™×œ ××ª ×”×ª×•×›× ×”...", "requesting": "×©×•×œ×— ×‘×§×©×” ×œ×©×¨×ª...",
                "downloading": "××•×¨×™×“...", "playlist_progress": "××•×¨×™×“ ×¤×¨×™×˜ {current} ××ª×•×š {total}", "merging": "×××—×“ ×•×™×“××• ×•××•×“×™×•...", "processing": "××¢×‘×“ ××ª ×”×§×•×‘×¥... (×××™×¨, ××•×¡×™×£ ×ª××•× ×” ×•××˜×-×“××˜×”)",
                "update_check": "×©×’×™××” ××¤×©×¨×™×ª, ×‘×•×“×§ ×× ×™×© ×¢×“×›×•×Ÿ ×œ-yt-dlp...", "updating": "××¢×“×›×Ÿ ××ª yt-dlp...", "success_message": "×”×§×•×‘×¥ × ××¦× ×‘×ª×™×§×™×™×ª ×”×”×•×¨×“×•×ª.", "settings_title": "×”×’×“×¨×•×ª",
                "language_label": "×©×¤×”",
                "download_another": "×”×•×¨×“ ×§×•×‘×¥ × ×•×¡×£", "error_message": "×”×”×•×¨×“×” × ×›×©×œ×”.", "view_log": "×¢×™×™×Ÿ ×‘×§×•×‘×¥ ×”×œ×•×’", "try_again": "× ×¡×” ×©×•×‘", "youtube_placeholder": "https://www.youtube.com/watch?v=",
                "download_btn_aria": "×”×•×¨×“", "quality_best": "××™×›×•×ª ××™×˜×‘×™×ª (MP4)", "quality_1080p": "1080p (MP4)", "quality_720p": "720p (MP4)", "quality_480p": "480p (MP4)",
                "playlist_confirm_mp3": "×–×•×”×” ×§×™×©×•×¨ ×œ×¤×œ×™×™×œ×™×¡×˜.\n\n×œ×—×¥ '××™×©×•×¨' (OK) ×›×“×™ ×œ×”×•×¨×™×“ ××ª ×›×œ ×”×¨×©×™××”.\n×œ×—×¥ '×‘×™×˜×•×œ' (Cancel) ×›×“×™ ×œ×”×•×¨×™×“ ×¨×§ ××ª ×”×©×™×¨ ×”×‘×•×“×“ ×”×–×”.",
                "playlist_confirm_video": "×–×•×”×” ×§×™×©×•×¨ ×œ×¤×œ×™×™×œ×™×¡×˜.\n\n×œ×—×¥ '××™×©×•×¨' (OK) ×›×“×™ ×œ×”×•×¨×™×“ ××ª ×›×œ ×”×¨×©×™××” ×›×§×‘×¦×™ ×•×™×“××•.\n×œ×—×¥ '×‘×™×˜×•×œ' (Cancel) ×›×“×™ ×œ×”×•×¨×™×“ ×¨×§ ××ª ×”×¡×¨×˜×•×Ÿ ×”×‘×•×“×“ ×”×–×”.",
                "invalid_url_alert": "×× × ×”×–×Ÿ ×§×™×©×•×¨ ×ª×§×™×Ÿ ××™×•×˜×™×•×‘.", "bookmark_info": "×›×“×™ ×œ×©××•×¨ ×›×¡×™×× ×™×”, × ×™×ª×Ÿ ×œ×’×¨×•×¨ ××ª ×”××™×™×§×•×Ÿ ×”×‘× ×œ×¡×¨×’×œ ×”×¡×™×× ×™×•×ª.",
                "bookmark_title": "NFmp3Downloader", "multi_link_instructions": "×”×“×‘×§ ×§×™×©×•×¨ ××—×“ ××™×•×˜×™×•×‘ ×‘×›×œ ×©×•×¨×”.", "multi_link_placeholder": "https://...\nhttps://...",
                "multi_download_btn": "×”×•×¨×“ ×”×›×œ (MP3)", "multi_cancel_btn": "×—×–×•×¨", "invalid_url_list_alert": "×× × ×”×–×Ÿ ×œ×¤×—×•×ª ×§×™×©×•×¨ ×ª×§×™×Ÿ ××—×“ ××™×•×˜×™×•×‘.", "netfree_user": "××¦×‘ ×ª××™××•×ª - × ×˜×¤×¨×™", "update_available": "×’×¨×¡×” ×—×“×©×” ×–××™× ×”!", "credits_rights": "Â© ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª ×œ-",
                "credits_bugs": "×œ××©×•×‘ ×•×“×™×•×•×— ×¢×œ ×‘××’×™×:",
                "whats_new": "××” ×—×“×©?",
                "download": "×”×•×¨×“",
                "dont_show_again": "××œ ×ª×¦×™×’ ×”×•×“×¢×” ×–×• ×©×•×‘", "netfree_warning_title": "×©×™× ×œ×‘: ××¦×‘ ×ª××™××•×ª",
                "netfree_warning_text": "××¦×‘ ×–×” ××™×•×¢×“ ×‘×¢×™×§×¨ ×œ××©×ª××©×™ × ×˜×¤×¨×™ ×”×¡×•×‘×œ×™× ××‘×¢×™×•×ª ×”×•×¨×“×” (×œ××©×œ ×’×•×œ×©×™ ×‘×–×§).<br><br>×× ×”×”×•×¨×“×” ×¢×•×‘×“×ª ×œ×š ×›×¨×’×™×œ, <strong>××•××œ×¥ ×œ×”×©××™×¨ ××¤×©×¨×•×ª ×–×• ×›×‘×•×™×”</strong> ×›×“×™ ×œ×§×‘×œ ××”×™×¨×•×ª ××§×¡×™××œ×™×ª.",
                "netfree_dont_show": "××œ ×ª×¦×™×’ ××–×”×¨×” ×–×• ×©×•×‘",
                "netfree_close_btn": "×”×‘× ×ª×™",
                "netfree_error_msg": "×©×’×™××”: ×”×—×™×‘×•×¨ × ×—×¡× ×¢\"×™ NetFree (×©×’×™××” 418).",
                "netfree_try_mode_btn": "× ×¡×” ×œ×”×¤×¢×™×œ ××¦×‘ ×ª××™××•×ª-× ×˜×¤×¨×™", "bg_color_label": "×¦×‘×¢ ×¨×§×¢", "bg_image_label": "×ª××•× ×ª ×¨×§×¢", "reset_bg_label": "××¤×¡ ×¨×§×¢", "dest_folder_label": "×ª×™×§×™×™×ª ×”×•×¨×“×”",

                "close": "×¡×’×•×¨"



            }
        };

        function parseReleaseNotes(fullNotes, lang) {
            const notesByLang = {};
            const regex = /(HE|EN):\s*([\s\S]*?)(?=\s*(?:HE|EN):|$)/g;

            let match;
            while ((match = regex.exec(fullNotes)) !== null) {
                notesByLang[match[1]] = match[2].trim();
            }

            const targetLang = lang.toUpperCase();
            return notesByLang[targetLang] || fullNotes;
        }


        document.addEventListener('DOMContentLoaded', () => {
            let translations = {};

            function applyTranslations(lang) {
                translations = allTranslations[lang] || allTranslations['en'];
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';

                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[key]) {
                        el.innerHTML = translations[key];
                    }
                }); document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    if (translations[key]) el.placeholder = translations[key];
                });
                document.querySelectorAll('[data-i18n-aria-label]').forEach(el => {
                    const key = el.getAttribute('data-i18n-aria-label');
                    if (translations[key]) el.setAttribute('aria-label', translations[key]);
                });

                const langSelect = document.getElementById('lang-select');
                if (langSelect) {
                    langSelect.value = lang;
                } document.getElementById('video-btn').textContent = "MP4 â¬‡ï¸";
                document.getElementById('multi-video-btn').textContent = "MP4 â¬‡ï¸";
                document.getElementById('multi-download-btn').textContent = translations.multi_download_btn;
                localStorage.setItem('lang', lang);
                document.getElementById('bookmarklet').href = window.location.href;
            }

            function initializeApp() {
                let downloadedFileNames = [];
                const mainContent = document.getElementById('main-content');
                const statusSection = document.getElementById('status-section');
                const urlInput = document.getElementById('youtube-url');
                const downloadBtn = document.getElementById('download-btn');
                const videoBtn = document.getElementById('video-btn');
                const videoDropdown = document.getElementById('video-quality-dropdown');
                const singleLinkSection = document.getElementById('single-link-section');
                const multiLinkSection = document.getElementById('multi-link-section');
                const multiLinkToggleBtn = document.getElementById('multi-link-toggle-btn');
                const multiLinkArea = document.getElementById('multi-link-area');
                const multiDownloadBtn = document.getElementById('multi-download-btn');
                const multiCancelBtn = document.getElementById('multi-cancel-btn');
                const topBackBtn = document.getElementById('top-back-btn');
                const multiVideoBtn = document.getElementById('multi-video-btn');
                const multiVideoDropdown = document.getElementById('multi-video-quality-dropdown');
                const destFolderRow = document.getElementById('dest-folder-row');
                const sidebarDestPath = document.getElementById('sidebar-dest-path');
                const savedPath = localStorage.getItem('destinationPath');
                if (savedPath && sidebarDestPath) {
                    sidebarDestPath.textContent = savedPath;
                    sidebarDestPath.title = savedPath;
                }
                const netfreeToggle = document.getElementById('netfree-toggle');
                const netfreeWarningModal = document.getElementById('netfree-warning-modal');
                const closeNetfreeWarning = document.getElementById('close-netfree-warning');
                const netfreeDontShow = document.getElementById('netfree-dont-show');
                const updateNotification = document.getElementById('update-notification');
                const updateText = document.getElementById('update-text');
                const whatsNewBtn = document.getElementById('whats-new-btn');
                const downloadUpdateBtn = document.getElementById('download-update-btn');
                const closeUpdateBtn = document.getElementById('close-update-btn');
                const dontShowAgainCheckbox = document.getElementById('dont-show-again-checkbox');
                const settingsBtn = document.getElementById('settings-btn');
                const sidebar = document.getElementById('settings-sidebar');
                const closeSidebarBtn = document.getElementById('close-sidebar-btn');
                const overlay = document.getElementById('sidebar-overlay');
                const langSelect = document.getElementById('lang-select');

                function toggleSidebar() {
                    sidebar.classList.toggle('open');
                    overlay.classList.toggle('visible');
                }

                const bgColorPicker = document.getElementById('bg-color-picker');
                const bgImageRow = document.getElementById('bg-image-row');
                const resetBgBtn = document.getElementById('reset-bg-btn');
                const resetBgContainer = document.getElementById('reset-bg-container');

                function applyBackground(type, value) {
                    if (type === 'color') {
                        document.body.style.backgroundImage = 'none';
                        document.body.style.backgroundColor = value;
                        localStorage.setItem('bgType', 'color');
                        localStorage.setItem('bgValue', value);
                        bgColorPicker.value = value;
                    } else if (type === 'image') {
                        const serverUrl = `http://localhost:9595/local-image?path=${encodeURIComponent(value)}&t=${Date.now()}`;
                        document.body.style.backgroundColor = 'transparent';
                        document.body.style.backgroundImage = `url('${serverUrl}')`;
                        document.body.style.backgroundSize = 'cover';
                        document.body.style.backgroundPosition = 'center';
                        document.body.style.backgroundAttachment = 'fixed';

                        localStorage.setItem('bgType', 'image');
                        localStorage.setItem('bgValue', value);
                    } else {
                        document.body.style.backgroundImage = '';
                        document.body.style.backgroundColor = 'var(--color-background)';
                        localStorage.removeItem('bgType');
                        localStorage.removeItem('bgValue');
                        bgColorPicker.value = '#222222';
                    }

                    resetBgContainer.style.display = (type === 'default') ? 'none' : 'block';
                }

                const savedBgType = localStorage.getItem('bgType');
                const savedBgValue = localStorage.getItem('bgValue');
                if (savedBgType && savedBgValue) {
                    applyBackground(savedBgType, savedBgValue);
                } else {
                    applyBackground('default', null);
                }

                bgColorPicker.addEventListener('input', (e) => {
                    applyBackground('color', e.target.value);
                });

                bgImageRow.addEventListener('click', () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        document.body.style.cursor = 'progress';
                        bgImageRow.style.cursor = 'progress';

                        ws.send(JSON.stringify({ type: 'select_background_image' }));
                    }
                });

                resetBgBtn.addEventListener('click', () => {
                    applyBackground('default', null);
                });

                settingsBtn.addEventListener('click', toggleSidebar);
                closeSidebarBtn.addEventListener('click', toggleSidebar);
                overlay.addEventListener('click', toggleSidebar);

                const currentLang = localStorage.getItem('lang') || 'en';
                langSelect.value = currentLang;

                langSelect.addEventListener('change', (e) => {
                    const newLang = e.target.value;
                    applyTranslations(newLang);
                });

                const isNetfreeSaved = localStorage.getItem('isNetfreeUser') === 'true';
                netfreeToggle.checked = isNetfreeSaved;

                netfreeToggle.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;

                    if (isChecked) {
                        const dontShowAgain = localStorage.getItem('dismissNetfreeWarning') === 'true';

                        if (!dontShowAgain) {
                            netfreeWarningModal.classList.add('visible');
                        }
                    }

                    localStorage.setItem('isNetfreeUser', isChecked);
                });

                closeNetfreeWarning.addEventListener('click', () => {
                    if (netfreeDontShow.checked) {
                        localStorage.setItem('dismissNetfreeWarning', 'true');
                    }
                    netfreeWarningModal.classList.remove('visible');
                });

                whatsNewBtn.addEventListener('click', () => {
                    if (latestReleaseNotes) {
                        const currentLang = localStorage.getItem('lang') || 'en';

                        const notesForLang = parseReleaseNotes(latestReleaseNotes, currentLang);

                        const formattedNotes = notesForLang.replace(/\\r\\n/g, '\n').replace(/\\n/g, '\n');

                        alert(formattedNotes);
                    }
                });

                closeUpdateBtn.addEventListener('click', () => {
                    if (dontShowAgainCheckbox.checked) {
                        localStorage.setItem('dismissedUpdateVersion', latestVersionAvailable);
                        console.log(`Dismissed version ${latestVersionAvailable}. It will not be shown again.`);
                    }
                    updateNotification.classList.remove('visible');
                });



                let lastDownloadWasQueue = false;

                multiVideoDropdown.innerHTML = videoDropdown.innerHTML;

                const statusMap = { connecting: document.getElementById('status-connecting'), launching: document.getElementById('status-launching'), requesting: document.getElementById('status-requesting'), downloading: document.getElementById('status-downloading'), playlist: document.getElementById('status-playlist'), merging: document.getElementById('status-merging'), processing: document.getElementById('status-processing'), update_check: document.getElementById('status-update-check'), updating: document.getElementById('status-updating'), success: document.getElementById('status-success'), error: document.getElementById('status-error'), cancelled: document.getElementById('status-cancelled'), queue_complete: document.getElementById('status-queue-complete') };
                const APP_PROTOCOL = 'nfmp3downloader://start';
                let ws;
                let isInitialConnection = true;



                function showStatus(statusKey) {
                    mainContent.style.display = 'none';
                    statusSection.style.display = 'block';
                    Object.values(statusMap).forEach(div => div.style.display = 'none');
                    if (statusKey && statusMap[statusKey]) {
                        statusMap[statusKey].style.display = 'block';
                    }
                }
                function showMainContent() {
                    mainContent.style.display = 'block';
                    singleLinkSection.style.display = 'block';
                    multiLinkSection.style.display = 'none';
                    statusSection.style.display = 'none';
                    videoDropdown.style.display = 'none';
                    multiVideoDropdown.style.display = 'none';
                }
                function handleInitialConnectionFailure() {
                    if (!isInitialConnection) return;
                    isInitialConnection = false;
                    showStatus('launching');
                    window.location.href = APP_PROTOCOL;
                    setTimeout(() => { location.reload(); }, 2500);
                }
                function connect() {
                    showStatus('connecting');
                    setAllButtonsDisabled(true);
                    const connectionTimeout = setTimeout(() => { if (isInitialConnection) { if (ws) ws.close(); handleInitialConnectionFailure(); } }, 2000);
                    ws = new WebSocket('ws://localhost:9595/ws');
                    ws.onopen = () => { clearTimeout(connectionTimeout); isInitialConnection = false; resetUI(); };
                    ws.onclose = () => { clearTimeout(connectionTimeout); if (isInitialConnection) handleInitialConnectionFailure(); setAllButtonsDisabled(true); };
                    ws.onerror = () => { };
                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            const { type, percent, speed, current, total, path } = data;
                            switch (type) {
                                case 'destination_selected':
                                    document.body.style.cursor = 'default';
                                    if (destFolderRow) destFolderRow.style.cursor = 'pointer';

                                    if (path) {
                                        if (sidebarDestPath) {
                                            sidebarDestPath.textContent = path;
                                            sidebarDestPath.title = path;
                                        }
                                        localStorage.setItem('destinationPath', path);
                                    }
                                    break; case 'background_selected':
                                    document.body.style.cursor = 'default';
                                    const bgRow = document.getElementById('bg-image-row');
                                    if (bgRow) bgRow.style.cursor = 'pointer';

                                    if (data.path) {
                                        applyBackground('image', data.path);
                                    }
                                    break;
                                case 'starting': showStatus('requesting'); break;
                                case 'progress':
                                    showStatus('downloading');
                                    document.getElementById('progress-bar').style.width = percent + '%';
                                    document.getElementById('progress-text').textContent = `${translations.downloading} ${parseFloat(percent).toFixed(1)}% (${speed || ''})`;
                                    break;
                                case 'playlist_progress':
                                    showStatus('playlist');
                                    const playlistTextEl = document.getElementById('playlist-progress-text');
                                    playlistTextEl.textContent = translations.playlist_progress.replace('{current}', current).replace('{total}', total);
                                    break;
                                case 'merging': showStatus('merging'); break;
                                case 'processing': showStatus('processing'); break;
                                case 'update_check': showStatus('update_check'); break;
                                case 'updating': showStatus('updating'); break;
                                case 'success':
                                    showStatus('success');
                                    const successTextEl = document.getElementById('success-text');

                                    const customPath = localStorage.getItem('destinationPath');
                                    if (customPath && !lastDownloadWasQueue) {
                                        successTextEl.textContent = translations.success_message_custom.replace('{path}', customPath);
                                    } else {
                                        successTextEl.textContent = lastDownloadWasQueue ? translations.success_message_multi : translations.success_message;
                                    }
                                    break; case 'cancelled': showStatus('cancelled'); break;
                                case 'netfree_error': case 'netfree_error':
                                    showStatus('error');
                                    const errorDiv = document.getElementById('status-error');

                                    errorDiv.innerHTML = `
                                        âŒ ${translations.netfree_error_msg}<br>
                                        <div style="margin-top: 10px;">
                                            <button id="open-netfree-settings" class="reset-btn" style="background-color: var(--color-red);">
                                                ${translations.netfree_try_mode_btn}
                                            </button>
                                        </div>
                                        <div style="margin-top: 5px;">
                                            <button class="reset-btn" onclick="location.reload()">${translations.try_again}</button>
                                        </div>
                                    `;

                                    document.getElementById('open-netfree-settings').addEventListener('click', () => {
                                        toggleSidebar();
                                        const netfreeRow = document.querySelector('#netfree-toggle').closest('.setting-row');
                                        netfreeRow.style.borderColor = 'var(--color-red)';
                                        setTimeout(() => netfreeRow.style.borderColor = '#444', 2000);
                                    });
                                    break;
                                case 'error': showStatus('error'); break;
                                case 'queue_complete':
                                    showStatus('queue_complete');
                                    const { successCount, failureCount, successfulFiles } = data;
                                    const queueTotal = successCount + failureCount;
                                    const textEl = document.getElementById('queue-complete-text');
                                    const iconEl = document.getElementById('queue-complete-icon');
                                    const statusBox = document.getElementById('status-queue-complete');
                                    const showBtn = document.getElementById('show-files-btn');

                                    if (failureCount === 0) {
                                        iconEl.textContent = 'âœ… ';
                                        textEl.textContent = translations.queue_complete_perfect.replace('{total}', queueTotal);
                                        statusBox.style.backgroundColor = 'rgba(46, 204, 113, 0.2)';
                                        statusBox.style.borderColor = '#2ecc71';
                                    } else if (successCount === 0) {
                                        iconEl.textContent = 'âŒ ';
                                        textEl.textContent = translations.queue_complete_fail.replace('{total}', queueTotal);
                                        statusBox.style.backgroundColor = 'rgba(234, 89, 77, 0.2)';
                                        statusBox.style.borderColor = 'var(--color-red)';
                                    } else {
                                        iconEl.textContent = 'âš ï¸ ';
                                        textEl.textContent = translations.queue_complete_partial
                                            .replace('{success}', successCount)
                                            .replace('{total}', queueTotal)
                                            .replace('{failed}', failureCount);
                                        statusBox.style.backgroundColor = 'rgba(241, 196, 15, 0.2)';
                                        statusBox.style.borderColor = '#f1c40f';

                                    }
                                    const existingLogLink = statusBox.querySelector('.log-link-container');
                                    if (existingLogLink) {
                                        existingLogLink.remove();
                                    }

                                    if (failureCount > 0) {
                                        const logLinkContainer = document.createElement('span');
                                        logLinkContainer.className = 'log-link-container';

                                        logLinkContainer.innerHTML = ` <a href="#" id="log-link-multi">${translations.view_log}</a>.`;

                                        textEl.appendChild(logLinkContainer);

                                        const newLogLink = document.getElementById('log-link-multi');
                                        if (newLogLink) {
                                            newLogLink.style.textDecoration = 'underline';
                                            newLogLink.style.cursor = 'pointer';
                                            newLogLink.style.color = 'var(--color-cream)';

                                            newLogLink.addEventListener('click', (e) => {
                                                e.preventDefault();
                                                if (ws && ws.readyState === WebSocket.OPEN) {
                                                    ws.send(JSON.stringify({ type: 'open_log' }));
                                                }
                                            });
                                        }
                                    }

                                    if (successfulFiles && successfulFiles.length > 0) {
                                        downloadedFileNames = successfulFiles;
                                        showBtn.style.display = 'inline-block';
                                    } else {
                                        downloadedFileNames = [];
                                        showBtn.style.display = 'none';
                                    }
                                    break;

                                case 'update_available':
                                    const dismissedVersion = localStorage.getItem('dismissedUpdateVersion');
                                    if (data.version === dismissedVersion) {
                                        console.log(`Update ${data.version} was dismissed by the user. Not showing.`);
                                        return;
                                    }

                                    latestVersionAvailable = data.version;
                                    latestReleaseNotes = data.releaseNotes;

                                    updateText.textContent = `${translations.update_available} (${latestVersionAvailable})`;
                                    if (data.downloadUrl) {
                                        const downloadBtn = document.getElementById('download-update-btn');
                                        if (downloadBtn) {
                                            downloadBtn.href = data.downloadUrl;
                                        }
                                    }
                                    updateNotification.classList.remove('hidden');
                                    updateNotification.classList.add('visible');
                                    break;

                            }
                        } catch (e) { console.error("Failed to parse server message:", event.data, e); }
                    };
                }
                function resetUI() {
                    showMainContent();
                    setAllButtonsDisabled(false);
                    urlInput.value = '';
                    multiLinkArea.value = '';
                    urlInput.focus();
                }
                function validateUrl(url) {
                    const trimmedUrl = url.trim();
                    if (!trimmedUrl || !(trimmedUrl.includes('youtube.com') || trimmedUrl.includes('youtu.be'))) {
                        return null;
                    }
                    return trimmedUrl;
                }

                function setAllButtonsDisabled(disabled) {
                    [urlInput, downloadBtn, videoBtn, multiLinkToggleBtn, multiDownloadBtn, multiVideoBtn, multiCancelBtn].forEach(el => el.disabled = disabled);
                }

                function getDownloadRequestObject(baseObject) {
                    const destinationPath = localStorage.getItem('destinationPath');

                    if (destinationPath) {
                        baseObject.destinationPath = destinationPath;
                    }
                    if (netfreeToggle.checked) {
                        baseObject.isNetfreeUser = true;
                    }

                    return baseObject;
                }
                downloadBtn.addEventListener('click', () => {
                    lastDownloadWasQueue = false;
                    const url = validateUrl(urlInput.value);
                    if (!url) { alert(translations.invalid_url_alert); return; }
                    let isPlaylist = false;
                    if (url.includes('&list=') || url.includes('?list=')) { if (confirm(translations.playlist_confirm_mp3)) { isPlaylist = true; } }
                    showStatus('requesting');
                    setAllButtonsDisabled(true);
                    const request = getDownloadRequestObject({ type: 'download', url: url, playlist: isPlaylist });
                    ws.send(JSON.stringify(request));
                });

                videoDropdown.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (event.target.tagName === 'A') {
                        lastDownloadWasQueue = false;
                        const formatId = event.target.dataset.format;
                        videoDropdown.style.display = 'none';
                        const url = validateUrl(urlInput.value);
                        if (!url) { alert(translations.invalid_url_alert); return; }
                        let isPlaylist = false;
                        if (url.includes('&list=') || url.includes('?list=')) { if (confirm(translations.playlist_confirm_video)) { isPlaylist = true; } }
                        showStatus('requesting');
                        setAllButtonsDisabled(true);
                        const request = getDownloadRequestObject({ type: 'download_video', url: url, formatId: formatId, playlist: isPlaylist });
                        ws.send(JSON.stringify(request));
                    }
                });

                function startMultiDownload(formatId) {
                    const urls = multiLinkArea.value.split('\n')
                        .map(url => validateUrl(url))
                        .filter(url => url !== null);

                    if (urls.length === 0) {
                        alert(translations.invalid_url_list_alert);
                        return;
                    }

                    lastDownloadWasQueue = true;
                    showStatus('playlist');
                    const playlistTextEl = document.getElementById('playlist-progress-text');
                    playlistTextEl.textContent = translations.playlist_progress.replace('{current}', '1').replace('{total}', urls.length);

                    setAllButtonsDisabled(true);
                    const request = getDownloadRequestObject({ type: 'download_queue', urls: urls, formatId: formatId });
                    ws.send(JSON.stringify(request));
                }


                videoBtn.addEventListener('click', () => { videoDropdown.style.display = videoDropdown.style.display === 'block' ? 'none' : 'block'; });
                const goBackToMain = () => {
                    singleLinkSection.style.display = 'block';
                    multiLinkSection.style.display = 'none';
                    topBackBtn.style.display = 'none';
                    urlInput.focus();
                };

                multiLinkToggleBtn.addEventListener('click', () => {
                    singleLinkSection.style.display = 'none';
                    multiLinkSection.style.display = 'block';
                    topBackBtn.style.display = 'block';
                    multiLinkArea.focus();
                });

                multiCancelBtn.addEventListener('click', goBackToMain);
                topBackBtn.addEventListener('click', goBackToMain);
                multiDownloadBtn.addEventListener('click', () => { startMultiDownload(null); });
                multiVideoBtn.addEventListener('click', () => { multiVideoDropdown.style.display = multiVideoDropdown.style.display === 'block' ? 'none' : 'block'; });
                multiVideoDropdown.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (event.target.tagName === 'A') {
                        const formatId = event.target.dataset.format;
                        multiVideoDropdown.style.display = 'none';
                        startMultiDownload(formatId);
                    }
                });

                if (destFolderRow) {
                    destFolderRow.addEventListener('click', () => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            document.body.style.cursor = 'progress';
                            destFolderRow.style.cursor = 'progress';

                            const currentLang = localStorage.getItem('lang') || 'en';
                            const dialogTitle = currentLang === 'he' ? '×‘×—×¨ ×ª×™×§×™×™×” ×œ×©××™×¨×”' : 'Select Download Folder';

                            ws.send(JSON.stringify({
                                type: 'select_destination',
                                title: dialogTitle
                            }));
                        }
                    });
                }
                document.querySelectorAll('.cancel-btn').forEach(btn => { btn.addEventListener('click', () => { if (ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify({ type: 'cancel_download' })); } }); });
                document.getElementById('show-files-btn').addEventListener('click', () => { if (downloadedFileNames.length > 0) { const fileList = downloadedFileNames.join('\n'); alert(translations.downloaded_files_title + '\n\n' + fileList); } });
                window.addEventListener('click', (event) => { if (!event.target.closest('.dropdown')) { videoDropdown.style.display = 'none'; multiVideoDropdown.style.display = 'none'; } });
                document.getElementById('log-link').addEventListener('click', () => { if (ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify({ type: 'open_log' })); } });
                document.querySelectorAll('.reset-btn').forEach(button => { button.addEventListener('click', resetUI); });

                connect();
            }


            const initialLang = localStorage.getItem('lang') || (navigator.language.startsWith('he') ? 'he' : 'en');
            applyTranslations(initialLang);
            initializeApp();
        });
    </script>
    <div id="netfree-warning-modal" class="custom-modal hidden">
        <div class="modal-content">
            <h3 data-i18n="netfree_warning_title">×©×™× ×œ×‘: ××¦×‘ ×ª××™××•×ª</h3>
            <p data-i18n="netfree_warning_text">
                ××¦×‘ ×–×” ××™×•×¢×“ ×‘×¢×™×§×¨ ×œ××©×ª××©×™ × ×˜×¤×¨×™...
            </p>
            <div class="modal-footer">
                <div class="checkbox-container">
                    <input type="checkbox" id="netfree-dont-show">
                    <label for="netfree-dont-show" data-i18n="netfree_dont_show">××œ ×ª×¦×™×’ ××–×”×¨×” ×–×• ×©×•×‘</label>
                </div>
                <button id="close-netfree-warning" class="reset-btn" data-i18n="netfree_close_btn">×”×‘× ×ª×™, ×¡×’×•×¨</button>
            </div>
        </div>
    </div>

</body>

</html>