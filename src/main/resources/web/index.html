<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="title">NFmp3Downloader</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-red: #ea594d;
            --color-blue: #4d90b3;
            --color-cream: #f2e9e4;
            --color-dark: #3a3535;
            --color-background: #222;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Varela Round', sans-serif;
            background-color: var(--color-background);
            color: var(--color-cream);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            position: relative;
        }

        button,
        input,
        textarea {
            font-family: 'Varela Round', sans-serif;
        }

        #top-controls {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 10;
            direction: ltr;
        }

        #lang-toggle {
            background: var(--color-dark);
            border: 1px solid #555;
            color: var(--color-cream);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            height: 36px;
            line-height: 24px;
        }

        #destination-section {
            display: flex;
            gap: 0;
            align-items: center;
        }

        #select-dest-btn {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            background-color: transparent;
            cursor: pointer;
            transition: border-color 0.2s;

            background-image: url('folder_ic.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;

            border: 2px solid var(--color-dark);
            border-radius: 8px;
        }

        #select-dest-btn:hover {
            border-color: var(--color-blue);
        }

        #destination-path-display {
            flex-grow: 1;
            width: 220px;
            height: 36px;
            padding: 0 10px;
            line-height: 34px;
            border-radius: 8px;
            border: 2px solid var(--color-dark);
            background-color: #3a3a3a;
            color: #ccc;
            font-size: 0.85rem;
            text-align: left;
            direction: ltr;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: default;
        }

        #app-container {
            width: 100%;
            max-width: 500px;
            padding: 2rem;
            background-color: #2c2c2c;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--color-dark);
        }

        header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 2rem;
        }

        #app-icon {
            width: 60px;
            height: 60px;
            content: url('icon.png');
        }

        h1 {
            font-size: 2rem;
            color: var(--color-red);
            text-shadow: 1px 1px 2px var(--color-dark);
        }

        #single-link-section {
            margin-bottom: 1.5rem;
        }

        #input-section {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .input-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        #youtube-url {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid var(--color-dark);
            background-color: #333;
            color: var(--color-cream);
            font-size: 1rem;
            text-align: left;
            direction: ltr;
            height: 48px;
        }

        #youtube-url:focus {
            outline: none;
            border-color: var(--color-blue);
        }

        #multi-link-toggle-btn {
            display: block;
            width: 210px;
            height: 32px;
            margin: 0 auto;
            border: none;
            background-color: transparent;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            transition: transform 0.1s, filter 0.2s;
        }

        #multi-link-toggle-btn:hover:not(:disabled) {
            filter: brightness(1.1);
        }

        #multi-link-toggle-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        html[lang="en"] #multi-link-toggle-btn {
            background-image: url('multi-link-en.png');
        }

        html[lang="he"] #multi-link-toggle-btn {
            background-image: url('multi-link-he.png');
        }

        #download-btn-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-shrink: 0;
        }

        #download-btn {
            border: none;
            background-color: transparent;
            background-image: url('download-button.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            height: 48px;
            width: 110px;
            cursor: pointer;
            transition: filter 0.3s, transform 0.1s;
        }

        #download-btn:hover:not(:disabled) {
            filter: brightness(1.15);
        }

        #download-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        #download-btn:disabled {
            cursor: not-allowed;
            filter: grayscale(1) opacity(0.5);
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .video-btn {
            height: 20px;
            width: 70px;
            padding: 0;
            font-size: 0.8rem;
            line-height: 20px;
            font-family: 'Varela Round', sans-serif;
            background-color: var(--color-dark);
            color: var(--color-cream);
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .video-btn:hover:not(:disabled) {
            background-color: #444;
            border-color: #777;
        }

        .video-btn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #3e3e3e;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.4);
            z-index: 1;
            border-radius: 5px;
            list-style: none;
            padding: 5px 0;
            top: 100%;
            margin-top: 5px;
            left: 50%;
            transform: translateX(-50%);
        }

        .dropdown-content a {
            color: var(--color-cream);
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            text-align: center;
            transition: background-color 0.2s;
            white-space: nowrap;
        }

        .dropdown-content a:hover {
            background-color: var(--color-blue);
        }

        #multi-link-section {
            margin-bottom: 1.5rem;
        }

        #multi-link-area {
            width: 100%;
            height: 150px;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid var(--color-dark);
            background-color: #333;
            color: var(--color-cream);
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 10px;
            direction: ltr;
            text-align: left;
        }

        #multi-link-area:focus {
            outline: none;
            border-color: var(--color-blue);
        }

        .multi-link-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .multi-link-buttons button,
        .multi-link-buttons .dropdown {
            width: 80%;
        }

        #multi-download-btn {
            padding: 10px 20px;
            font-size: 1rem;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            background-color: var(--color-blue);
            color: white;
        }

        #multi-download-btn:hover {
            filter: brightness(1.15);
        }

        #multi-video-btn {
            height: auto;
            width: 100%;
            padding: 5px 15px;
        }

        #multi-cancel-btn {
            background-color: var(--color-red);
            color: white;
            margin-top: 10px;
            padding: 8px 15px;
            font-size: 0.9rem;
            width: 40%;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }

        #multi-cancel-btn:hover {
            filter: brightness(1.15);
        }

        .status-message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.2);
            font-size: 1.1rem;
        }

        #status-error,
        #status-cancelled {
            background-color: rgba(234, 89, 77, 0.2);
            border: 1px solid var(--color-red);
        }

        #status-success {
            background-color: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
        }

        #log-link {
            color: var(--color-cream);
            text-decoration: underline;
            cursor: pointer;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--color-blue);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .progress-bar-container {
            width: 100%;
            background-color: #333;
            border-radius: 20px;
            border: 1px solid var(--color-dark);
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-bar {
            width: 0%;
            height: 20px;
            background-color: var(--color-blue);
            border-radius: 20px;
            transition: width 0.3s ease-in-out;
            text-align: center;
            line-height: 20px;
            color: white;
        }

        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            height: 30px;
        }

        .loading-dots div {
            width: 12px;
            height: 12px;
            background-color: var(--color-blue);
            border-radius: 50%;
            animation: bounce 1.2s infinite ease-in-out;
        }

        .loading-dots div:nth-child(2) {
            animation-delay: -0.2s;
        }

        .loading-dots div:nth-child(3) {
            animation-delay: -0.4s;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: scale(0.8);
                opacity: 0.6;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        .reset-btn {
            background-color: var(--color-blue);
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 15px;
        }

        .reset-btn:hover {
            background-color: #6aabd1;
        }

        .cancel-btn-container {
            margin-top: 15px;
        }

        .cancel-btn {
            background-color: var(--color-dark);
            color: var(--color-cream);
            border: 1px solid #555;
            border-radius: 5px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .cancel-btn:hover {
            background-color: #444;
        }

        footer {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #aaa;
        }

        #bookmarklet {
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: var(--color-red);
            background-image: url('icon.png');
            background-size: 85%;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 5px;
            cursor: grab;
            user-select: none;
            font-size: 0;
            margin-top: 10px;
        }

        #bookmarklet:hover {
            background-color: #d8483b;
        }

        #multi-cancel-btn {
            display: none;
        }
    </style>
</head>

<body>

    <!-- הנה הקוד המתוקן והשלם עבור כל החלק העליון -->
    <div id="top-controls">
        <button id="lang-toggle"></button> <!-- הכפתור הזה היה חסר -->
        <div id="destination-section"> <!-- ה-div הזה היה חסר, והוא חשוב למרווחים -->
            <button id="select-dest-btn" aria-label="Select download folder"></button>
            <input type="text" id="destination-path-display" data-i18n-placeholder="destination_placeholder" readonly>
        </div>
    </div>

    <div id="app-container">
        <header>
            <img id="app-icon" alt="App Icon">
            <h1 data-i18n="title">NFmp3Downloader</h1>
        </header>
        <main>
            <div id="main-content">
                <div id="single-link-section">
                    <div id="input-section">
                        <div class="input-wrapper">
                            <input type="url" id="youtube-url" data-i18n-placeholder="youtube_placeholder">
                            <button id="multi-link-toggle-btn"></button>
                        </div>
                        <div id="download-btn-container">
                            <button id="download-btn" data-i18n-aria-label="download_btn_aria"></button>
                            <div class="dropdown">
                                <button id="video-btn" class="video-btn"></button>
                                <div id="video-quality-dropdown" class="dropdown-content">
                                    <a href="#" data-format="bestvideo[ext=mp4]+bestaudio[ext=m4a]/best[ext=mp4]/best"
                                        data-i18n="quality_best"></a>
                                    <a href="#"
                                        data-format="bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]/best[height<=1080][ext=mp4]/best[height<=1080]"
                                        data-i18n="quality_1080p"></a>
                                    <a href="#"
                                        data-format="bestvideo[height<=720][ext=mp4]+bestaudio[ext=m4a]/best[height<=720][ext=mp4]/best[height<=720]"
                                        data-i18n="quality_720p"></a>
                                    <a href="#"
                                        data-format="bestvideo[height<=480][ext=mp4]+bestaudio[ext=m4a]/best[height<=480][ext=mp4]/best[height<=480]"
                                        data-i18n="quality_480p"></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="multi-link-section" style="display: none;">
                    <p data-i18n="multi_link_instructions"></p>
                    <textarea id="multi-link-area" data-i18n-placeholder="multi_link_placeholder"></textarea>
                    <div class="multi-link-buttons">
                        <button id="multi-download-btn"></button>
                        <div class="dropdown">
                            <button id="multi-video-btn" class="video-btn"></button>
                            <div id="multi-video-quality-dropdown" class="dropdown-content"></div>
                        </div>
                        <button id="multi-cancel-btn" data-i18n="multi_cancel_btn"></button>
                    </div>
                </div>
            </div>

            <div id="status-section">
                <div id="status-connecting" class="status-message" data-i18n="connecting"></div>
                <div id="status-launching" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="launching"></span>
                </div>
                <div id="status-requesting" class="status-message" style="display: none;">
                    <div class="loading-dots">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div><span data-i18n="requesting"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button></div>
                </div>
                <div id="status-downloading" class="status-message" style="display: none;">
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar"></div>
                    </div>
                    <span id="progress-text"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button></div>
                </div>
                <div id="status-playlist" class="status-message" style="display: none;">
                    <div class="loading-dots">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <span id="playlist-progress-text"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button></div>
                </div>
                <div id="status-merging" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="merging"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button></div>
                </div>
                <div id="status-processing" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="processing"></span>
                    <div class="cancel-btn-container"><button class="cancel-btn" data-i18n="cancel_btn"></button></div>
                </div>
                <div id="status-update-check" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="update_check"></span>
                </div>
                <div id="status-updating" class="status-message" style="display: none;">
                    <div class="spinner"></div><span data-i18n="updating"></span>
                </div>
                <div id="status-success" class="status-message" style="display: none;">✅ <span
                        id="success-text"></span><br><button class="reset-btn" data-i18n="download_another"></button>
                </div>
                <div id="status-error" class="status-message" style="display: none;">❌ <span
                        data-i18n="error_message"></span> <span id="log-link" data-i18n="view_log"></span>.<br><button
                        class="reset-btn" data-i18n="try_again"></button></div>
                <div id="status-cancelled" class="status-message" style="display: none;">🚫 <span
                        data-i18n="cancelled_message"></span><br><button class="reset-btn"
                        data-i18n="try_again"></button></div>
                <div id="status-queue-complete" class="status-message" style="display: none;">
                    <span id="queue-complete-icon"></span>
                    <span id="queue-complete-text"></span><br>
                    <button id="show-files-btn" class="reset-btn" data-i18n="show_files_btn"
                        style="display: none;"></button>
                    <button class="reset-btn" data-i18n="download_another"></button>
                </div>
            </div>
        </main>
        <footer>
            <p id="bookmark-info" data-i18n="bookmark_info"></p>
            <a id="bookmarklet" href="#" data-i18n="bookmark_title"></a>
        </footer>
    </div>

    <script>
        const allTranslations = {
            "en": {
                "destination_placeholder": "Save to: (Default: Downloads)",
                "success_message_custom": "The file is in: {path}",
                "multi_link_btn": "Download multiple links",
                "success_message_multi": "The files are in a new folder in your Downloads.",
                "cancel_btn": "Cancel",
                "cancelled_message": "The download was cancelled.",
                "queue_complete_perfect": "All {total} files were downloaded successfully!",
                "queue_complete_partial": "{success} of {total} files downloaded. {failed} failed.",
                "queue_complete_fail": "All {total} files failed to download.",
                "show_files_btn": "Show downloaded files",
                "downloaded_files_title": "Downloaded Files:",
                "lang_toggle": "🌐 עברית", "title": "NFmp3Downloader", "connecting": "Connecting to service...", "launching": "Launching the application...",
                "requesting": "Sending request to server...", "downloading": "Downloading...", "playlist_progress": "Downloading item {current} of {total}",
                "merging": "Merging video and audio...", "processing": "Processing file... (adding thumbnail & metadata)", "update_check": "Possible error, checking for yt-dlp update...",
                "updating": "Update found, installing...", "success_message": "The file is in your Downloads folder.", "download_another": "Download another file",
                "error_message": "The download has failed.", "view_log": "View the log file", "try_again": "Try again", "youtube_placeholder": "https://www.youtube.com/watch?v=",
                "download_btn_aria": "Download", "quality_best": "Best Quality (MP4)", "quality_1080p": "1080p (MP4)", "quality_720p": "720p (MP4)", "quality_480p": "480p (MP4)",
                "playlist_confirm_mp3": "Playlist link detected.\n\nClick 'OK' to download the entire list.\nClick 'Cancel' to download only this single track.",
                "playlist_confirm_video": "Playlist link detected.\n\nClick 'OK' to download the entire list as video files.\nClick 'Cancel' to download only this single video.",
                "invalid_url_alert": "Please enter a valid YouTube link.", "bookmark_info": "To save as a bookmark, drag the following icon to your bookmarks bar.",
                "bookmark_title": "NFmp3Downloader", "multi_link_instructions": "Paste one YouTube link per line.", "multi_link_placeholder": "https://...\nhttps://...",
                "multi_download_btn": "Download All (MP3)", "multi_cancel_btn": "Back", "invalid_url_list_alert": "Please enter at least one valid YouTube link."
            },
            "he": {
                "destination_placeholder": "שמור ב: (ברירת מחדל: הורדות)",
                "success_message_custom": "הקובץ נמצא בתיקייה: {path}",
                "multi_link_btn": "הורד קישורים מרובים",
                "success_message_multi": "הקבצים נמצאים בתיקייה חדשה בתוך תיקיית ההורדות.",
                "cancel_btn": "בטל",
                "cancelled_message": "ההורדה בוטלה.",
                "queue_complete_perfect": "כל {total} הקבצים ירדו בהצלחה!",
                "queue_complete_partial": "{success} מתוך {total} קבצים ירדו. {failed} נכשלו.",
                "queue_complete_fail": "ההורדה של כל {total} הקבצים נכשלה.",
                "show_files_btn": "הצג קבצים שהורדו",
                "downloaded_files_title": "קבצים שהורדו:",
                "lang_toggle": "🌐 English", "title": "NFmp3Downloader", "connecting": "מתחבר לשירות...", "launching": "מפעיל את התוכנה...", "requesting": "שולח בקשה לשרת...",
                "downloading": "מוריד...", "playlist_progress": "מוריד פריט {current} מתוך {total}", "merging": "מאחד וידאו ואודיו...", "processing": "מעבד את הקובץ... (מוסיף תמונה ומטא-דאטה)",
                "update_check": "שגיאה אפשרית, בודק אם יש עדכון ל-yt-dlp...", "updating": "נמצא עדכון, מתקין...", "success_message": "הקובץ נמצא בתיקיית ההורדות.",
                "download_another": "הורד קובץ נוסף", "error_message": "ההורדה נכשלה.", "view_log": "עיין בקובץ הלוג", "try_again": "נסה שוב", "youtube_placeholder": "https://www.youtube.com/watch?v=",
                "download_btn_aria": "הורד", "quality_best": "איכות מיטבית (MP4)", "quality_1080p": "1080p (MP4)", "quality_720p": "720p (MP4)", "quality_480p": "480p (MP4)",
                "playlist_confirm_mp3": "זוהה קישור לפלייליסט.\n\nלחץ 'אישור' (OK) כדי להוריד את כל הרשימה.\nלחץ 'ביטול' (Cancel) כדי להוריד רק את השיר הבודד הזה.",
                "playlist_confirm_video": "זוהה קישור לפלייליסט.\n\nלחץ 'אישור' (OK) כדי להוריד את כל הרשימה כקבצי וידאו.\nלחץ 'ביטול' (Cancel) כדי להוריד רק את הסרטון הבודד הזה.",
                "invalid_url_alert": "אנא הזן קישור תקין מיוטיוב.", "bookmark_info": "כדי לשמור כסימניה, ניתן לגרור את האייקון הבא לסרגל הסימניות.",
                "bookmark_title": "NFmp3Downloader", "multi_link_instructions": "הדבק קישור אחד מיוטיוב בכל שורה.", "multi_link_placeholder": "https://...\nhttps://...",
                "multi_download_btn": "הורד הכל (MP3)", "multi_cancel_btn": "חזור", "invalid_url_list_alert": "אנא הזן לפחות קישור תקין אחד מיוטיוב."
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            let translations = {};

            function applyTranslations(lang) {
                translations = allTranslations[lang] || allTranslations['en'];
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';

                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[key]) el.textContent = translations[key];
                });
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-i18n-placeholder');
                    if (translations[key]) el.placeholder = translations[key];
                });
                document.querySelectorAll('[data-i18n-aria-label]').forEach(el => {
                    const key = el.getAttribute('data-i18n-aria-label');
                    if (translations[key]) el.setAttribute('aria-label', translations[key]);
                });

                document.getElementById('lang-toggle').textContent = translations.lang_toggle;
                document.getElementById('video-btn').textContent = "MP4 ⬇️";
                document.getElementById('multi-video-btn').textContent = "MP4 ⬇️";
                document.getElementById('multi-download-btn').textContent = translations.multi_download_btn;
                localStorage.setItem('lang', lang);
                document.getElementById('bookmarklet').href = window.location.href;
            }

            function initializeApp() {
                let downloadedFileNames = [];
                const mainContent = document.getElementById('main-content');
                const statusSection = document.getElementById('status-section');
                const urlInput = document.getElementById('youtube-url');
                const downloadBtn = document.getElementById('download-btn');
                const videoBtn = document.getElementById('video-btn');
                const videoDropdown = document.getElementById('video-quality-dropdown');
                const selectDestBtn = document.getElementById('select-dest-btn');
                const destPathDisplay = document.getElementById('destination-path-display');

                const singleLinkSection = document.getElementById('single-link-section');
                const multiLinkSection = document.getElementById('multi-link-section');
                const multiLinkToggleBtn = document.getElementById('multi-link-toggle-btn');
                const multiLinkArea = document.getElementById('multi-link-area');
                const multiDownloadBtn = document.getElementById('multi-download-btn');
                const multiCancelBtn = document.getElementById('multi-cancel-btn');
                const multiVideoBtn = document.getElementById('multi-video-btn');
                const multiVideoDropdown = document.getElementById('multi-video-quality-dropdown');
                let lastDownloadWasQueue = false;

                multiVideoDropdown.innerHTML = videoDropdown.innerHTML;

                const statusMap = { connecting: document.getElementById('status-connecting'), launching: document.getElementById('status-launching'), requesting: document.getElementById('status-requesting'), downloading: document.getElementById('status-downloading'), playlist: document.getElementById('status-playlist'), merging: document.getElementById('status-merging'), processing: document.getElementById('status-processing'), update_check: document.getElementById('status-update-check'), updating: document.getElementById('status-updating'), success: document.getElementById('status-success'), error: document.getElementById('status-error'), cancelled: document.getElementById('status-cancelled'), queue_complete: document.getElementById('status-queue-complete') };
                const APP_PROTOCOL = 'nfmp3downloader://start';
                let ws;
                let isInitialConnection = true;

                const savedPath = localStorage.getItem('destinationPath');
                if (savedPath) {
                    destPathDisplay.value = savedPath;
                }

                function showStatus(statusKey) {
                    mainContent.style.display = 'none';
                    statusSection.style.display = 'block';
                    Object.values(statusMap).forEach(div => div.style.display = 'none');
                    if (statusKey && statusMap[statusKey]) {
                        statusMap[statusKey].style.display = 'block';
                    }
                }
                function showMainContent() {
                    mainContent.style.display = 'block';
                    singleLinkSection.style.display = 'block';
                    multiLinkSection.style.display = 'none';
                    statusSection.style.display = 'none';
                    videoDropdown.style.display = 'none';
                    multiVideoDropdown.style.display = 'none';
                }
                function handleInitialConnectionFailure() {
                    if (!isInitialConnection) return;
                    isInitialConnection = false;
                    showStatus('launching');
                    window.location.href = APP_PROTOCOL;
                    setTimeout(() => { location.reload(); }, 2500);
                }
                function connect() {
                    showStatus('connecting');
                    setAllButtonsDisabled(true);
                    const connectionTimeout = setTimeout(() => { if (isInitialConnection) { if (ws) ws.close(); handleInitialConnectionFailure(); } }, 2000);
                    ws = new WebSocket('ws://localhost:9595/ws');
                    ws.onopen = () => { clearTimeout(connectionTimeout); isInitialConnection = false; resetUI(); };
                    ws.onclose = () => { clearTimeout(connectionTimeout); if (isInitialConnection) handleInitialConnectionFailure(); setAllButtonsDisabled(true); };
                    ws.onerror = () => { };
                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            const { type, percent, speed, current, total, path } = data;
                            switch (type) {
                                case 'destination_selected':
                                    if (path) {
                                        destPathDisplay.value = path;
                                        localStorage.setItem('destinationPath', path);
                                    }
                                    break;
                                case 'starting': showStatus('requesting'); break;
                                case 'progress':
                                    showStatus('downloading');
                                    document.getElementById('progress-bar').style.width = percent + '%';
                                    document.getElementById('progress-text').textContent = `${translations.downloading} ${parseFloat(percent).toFixed(1)}% (${speed || ''})`;
                                    break;
                                case 'playlist_progress':
                                    showStatus('playlist');
                                    const playlistTextEl = document.getElementById('playlist-progress-text');
                                    playlistTextEl.textContent = translations.playlist_progress.replace('{current}', current).replace('{total}', total);
                                    break;
                                case 'merging': showStatus('merging'); break;
                                case 'processing': showStatus('processing'); break;
                                case 'update_check': showStatus('update_check'); break;
                                case 'updating': showStatus('updating'); break;
                                case 'success':
                                    showStatus('success');
                                    const successTextEl = document.getElementById('success-text');
                                    const customPath = destPathDisplay.value;
                                    if (customPath && !lastDownloadWasQueue) {
                                        successTextEl.textContent = translations.success_message_custom.replace('{path}', customPath);
                                    } else {
                                        successTextEl.textContent = lastDownloadWasQueue ? translations.success_message_multi : translations.success_message;
                                    }
                                    break;
                                case 'cancelled': showStatus('cancelled'); break;
                                case 'error': showStatus('error'); break;
                                case 'queue_complete':
                                    showStatus('queue_complete');
                                    const { successCount, failureCount, successfulFiles } = data;
                                    const queueTotal = successCount + failureCount;
                                    const textEl = document.getElementById('queue-complete-text');
                                    const iconEl = document.getElementById('queue-complete-icon');
                                    const statusBox = document.getElementById('status-queue-complete');
                                    const showBtn = document.getElementById('show-files-btn');

                                    if (failureCount === 0) {
                                        iconEl.textContent = '✅ ';
                                        textEl.textContent = translations.queue_complete_perfect.replace('{total}', queueTotal);
                                        statusBox.style.backgroundColor = 'rgba(46, 204, 113, 0.2)';
                                        statusBox.style.borderColor = '#2ecc71';
                                    } else if (successCount === 0) {
                                        iconEl.textContent = '❌ ';
                                        textEl.textContent = translations.queue_complete_fail.replace('{total}', queueTotal);
                                        statusBox.style.backgroundColor = 'rgba(234, 89, 77, 0.2)';
                                        statusBox.style.borderColor = 'var(--color-red)';
                                    } else {
                                        iconEl.textContent = '⚠️ ';
                                        textEl.textContent = translations.queue_complete_partial
                                            .replace('{success}', successCount)
                                            .replace('{total}', queueTotal)
                                            .replace('{failed}', failureCount);
                                        statusBox.style.backgroundColor = 'rgba(241, 196, 15, 0.2)';
                                        statusBox.style.borderColor = '#f1c40f';
                                    }

                                    if (successfulFiles && successfulFiles.length > 0) {
                                        downloadedFileNames = successfulFiles;
                                        showBtn.style.display = 'inline-block';
                                    } else {
                                        downloadedFileNames = [];
                                        showBtn.style.display = 'none';
                                    }
                                    break;
                            }
                        } catch (e) { console.error("Failed to parse server message:", event.data, e); }
                    };
                }
                function resetUI() {
                    showMainContent();
                    setAllButtonsDisabled(false);
                    urlInput.value = '';
                    multiLinkArea.value = '';
                    urlInput.focus();
                }
                function validateUrl(url) {
                    const trimmedUrl = url.trim();
                    if (!trimmedUrl || !(trimmedUrl.includes('youtube.com') || trimmedUrl.includes('youtu.be'))) {
                        return null;
                    }
                    return trimmedUrl;
                }

                function setAllButtonsDisabled(disabled) {
                    [urlInput, downloadBtn, videoBtn, multiLinkToggleBtn, multiDownloadBtn, multiVideoBtn, multiCancelBtn, selectDestBtn].forEach(el => el.disabled = disabled);
                }

                function getDownloadRequestObject(baseObject) {
                    const destinationPath = destPathDisplay.value;
                    if (destinationPath) {
                        baseObject.destinationPath = destinationPath;
                    }
                    return baseObject;
                }

                downloadBtn.addEventListener('click', () => {
                    lastDownloadWasQueue = false;
                    const url = validateUrl(urlInput.value);
                    if (!url) { alert(translations.invalid_url_alert); return; }
                    let isPlaylist = false;
                    if (url.includes('&list=') || url.includes('?list=')) { if (confirm(translations.playlist_confirm_mp3)) { isPlaylist = true; } }
                    showStatus('requesting');
                    setAllButtonsDisabled(true);
                    const request = getDownloadRequestObject({ type: 'download', url: url, playlist: isPlaylist });
                    ws.send(JSON.stringify(request));
                });

                videoDropdown.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (event.target.tagName === 'A') {
                        lastDownloadWasQueue = false;
                        const formatId = event.target.dataset.format;
                        videoDropdown.style.display = 'none';
                        const url = validateUrl(urlInput.value);
                        if (!url) { alert(translations.invalid_url_alert); return; }
                        let isPlaylist = false;
                        if (url.includes('&list=') || url.includes('?list=')) { if (confirm(translations.playlist_confirm_video)) { isPlaylist = true; } }
                        showStatus('requesting');
                        setAllButtonsDisabled(true);
                        const request = getDownloadRequestObject({ type: 'download_video', url: url, formatId: formatId, playlist: isPlaylist });
                        ws.send(JSON.stringify(request));
                    }
                });

                function startMultiDownload(formatId) {
                    const urls = multiLinkArea.value.split('\n')
                        .map(url => validateUrl(url))
                        .filter(url => url !== null);

                    if (urls.length === 0) {
                        alert(translations.invalid_url_list_alert);
                        return;
                    }

                    lastDownloadWasQueue = true;
                    showStatus('playlist');
                    const playlistTextEl = document.getElementById('playlist-progress-text');
                    playlistTextEl.textContent = translations.playlist_progress.replace('{current}', '1').replace('{total}', urls.length);

                    setAllButtonsDisabled(true);
                    const request = getDownloadRequestObject({ type: 'download_queue', urls: urls, formatId: formatId });
                    ws.send(JSON.stringify(request));
                }

                selectDestBtn.addEventListener('click', () => {
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'select_destination' }));
                    }
                });

                videoBtn.addEventListener('click', () => { videoDropdown.style.display = videoDropdown.style.display === 'block' ? 'none' : 'block'; });
                multiLinkToggleBtn.addEventListener('click', () => { singleLinkSection.style.display = 'none'; multiLinkSection.style.display = 'block'; multiLinkArea.focus(); });
                multiCancelBtn.addEventListener('click', () => { singleLinkSection.style.display = 'block'; multiLinkSection.style.display = 'none'; urlInput.focus(); });
                multiDownloadBtn.addEventListener('click', () => { startMultiDownload(null); });
                multiVideoBtn.addEventListener('click', () => { multiVideoDropdown.style.display = multiVideoDropdown.style.display === 'block' ? 'none' : 'block'; });
                multiVideoDropdown.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (event.target.tagName === 'A') {
                        const formatId = event.target.dataset.format;
                        multiVideoDropdown.style.display = 'none';
                        startMultiDownload(formatId);
                    }
                });
                document.querySelectorAll('.cancel-btn').forEach(btn => { btn.addEventListener('click', () => { if (ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify({ type: 'cancel_download' })); } }); });
                document.getElementById('show-files-btn').addEventListener('click', () => { if (downloadedFileNames.length > 0) { const fileList = downloadedFileNames.join('\n'); alert(translations.downloaded_files_title + '\n\n' + fileList); } });
                window.addEventListener('click', (event) => { if (!event.target.closest('.dropdown')) { videoDropdown.style.display = 'none'; multiVideoDropdown.style.display = 'none'; } });
                document.getElementById('log-link').addEventListener('click', () => { if (ws && ws.readyState === WebSocket.OPEN) { ws.send(JSON.stringify({ type: 'open_log' })); } });
                document.querySelectorAll('.reset-btn').forEach(button => { button.addEventListener('click', resetUI); });

                connect();
            }

            document.getElementById('lang-toggle').addEventListener('click', () => {
                const currentLang = localStorage.getItem('lang') || 'en';
                const newLang = currentLang === 'he' ? 'en' : 'he';
                applyTranslations(newLang);
            });

            const initialLang = localStorage.getItem('lang') || (navigator.language.startsWith('he') ? 'he' : 'en');
            applyTranslations(initialLang);
            initializeApp();
        });
    </script>
</body>

</html>